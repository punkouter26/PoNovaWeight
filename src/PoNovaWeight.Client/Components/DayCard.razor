@using PoNovaWeight.Shared.Contracts

<a href="/day/@Day.Date.ToString("yyyy-MM-dd")" 
   class="block bg-white dark:bg-dark-card rounded-2xl shadow-elevation-2 hover:shadow-elevation-3 border border-healthy-light dark:border-dark-border p-4 transition-all duration-200 @(IsToday ? "ring-2 ring-healthy-primary ring-offset-2 dark:ring-offset-dark-bg" : "")">
    
    <!-- Header with icon and date -->
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
            <div class="w-11 h-11 rounded-xl flex items-center justify-center @GetDayBgClass()">
                @((MarkupString)GetDayIcon())
            </div>
            <div>
                <div class="font-semibold text-healthy-text dark:text-dark-text text-sm">@Day.Date.ToString("ddd")</div>
                <div class="text-xs text-healthy-muted dark:text-dark-muted">@Day.Date.ToString("MMM d")</div>
            </div>
        </div>
        @if (IsToday)
        {
            <span class="text-xs px-3 py-1 bg-healthy-primary text-white rounded-full font-medium shadow-sm">Today</span>
        }
        else
        {
            <div class="text-right">
                <span class="text-lg font-bold text-healthy-text dark:text-dark-text">@GetCompletionPercent()%</span>
                <div class="text-xs text-healthy-muted dark:text-dark-muted">complete</div>
            </div>
        }
    </div>

    <!-- Category progress bars -->
    <div class="flex gap-1.5 mb-3">
        @foreach (var category in Categories)
        {
            var current = Day.GetUnits(category);
            var target = UnitCategoryInfo.GetDailyTarget(category);
            var percent = target > 0 ? Math.Min(100, (int)((double)current / target * 100)) : 0;
            var isOver = current > target;

            <div class="flex-1 h-2 rounded-full bg-gray-100 dark:bg-dark-border overflow-hidden" title="@GetShortName(category): @current/@target">
                <div class="h-full rounded-full transition-all @GetCategoryColor(category, isOver, current >= target)" 
                     style="width: @percent%"></div>
            </div>
        }
    </div>

    <!-- Stats row with icons -->
    <div class="flex items-center justify-between text-xs">
        <div class="flex items-center gap-3">
            @foreach (var category in Categories.Take(3))
            {
                var current = Day.GetUnits(category);
                <span class="flex items-center gap-1 text-healthy-muted dark:text-dark-muted">
                    @((MarkupString)GetCategoryIcon(category))
                    @current
                </span>
            }
        </div>
        
        <!-- Water indicator -->
        <div class="flex items-center gap-1.5">
            <svg class="w-4 h-4 text-healthy-water" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/></svg>
            <span class="text-healthy-muted dark:text-dark-muted font-medium">@Day.WaterSegments/8</span>
        </div>
    </div>
</a>

@code {
    [Parameter, EditorRequired]
    public DailyLogDto Day { get; set; } = null!;

    [Parameter]
    public bool ShowWater { get; set; } = true;

    private bool IsToday => Day.Date == DateOnly.FromDateTime(DateTime.Today);

    private static readonly UnitCategory[] Categories = Enum.GetValues<UnitCategory>();

    private int GetCompletionPercent()
    {
        int total = 0, achieved = 0;
        foreach (var cat in Categories)
        {
            var current = Day.GetUnits(cat);
            var target = UnitCategoryInfo.GetDailyTarget(cat);
            if (target > 0)
            {
                total += target;
                achieved += Math.Min(current, target);
            }
        }
        return total > 0 ? (int)((double)achieved / total * 100) : 0;
    }

    private string GetDayBgClass()
    {
        var percent = GetCompletionPercent();
        return percent >= 90 ? "bg-amber-100 dark:bg-amber-900/30" : 
               percent >= 70 ? "bg-emerald-100 dark:bg-emerald-900/30" : 
               percent >= 50 ? "bg-sky-100 dark:bg-sky-900/30" : 
               "bg-gray-100 dark:bg-dark-border";
    }

    private string GetDayIcon()
    {
        var percent = GetCompletionPercent();
        if (percent >= 90)
            return "<svg class=\"w-6 h-6 text-amber-500\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z\"/></svg>";
        if (percent >= 70)
            return "<svg class=\"w-6 h-6 text-emerald-500\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z\"/></svg>";
        if (percent >= 50)
            return "<svg class=\"w-6 h-6 text-sky-500\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18\"/></svg>";
        return "<svg class=\"w-6 h-6 text-gray-400 dark:text-dark-muted\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5\"/></svg>";
    }

    private static string GetShortName(UnitCategory category) => category switch
    {
        UnitCategory.Proteins => "Protein",
        UnitCategory.Vegetables => "Veggies",
        UnitCategory.Fruits => "Fruit",
        UnitCategory.Starches => "Starch",
        UnitCategory.Fats => "Fat",
        UnitCategory.Dairy => "Dairy",
        _ => category.ToString()
    };

    private static string GetCategoryIcon(UnitCategory category) => category switch
    {
        UnitCategory.Proteins => "<svg class=\"w-3.5 h-3.5 text-amber-600\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z\"/></svg>",
        UnitCategory.Vegetables => "<svg class=\"w-3.5 h-3.5 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18\"/></svg>",
        UnitCategory.Fruits => "<svg class=\"w-3.5 h-3.5 text-rose-500\" fill=\"currentColor\" viewBox=\"0 0 24 24\"><path d=\"M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z\"/></svg>",
        _ => "<span class=\"w-1.5 h-1.5 rounded-full bg-gray-400\"></span>"
    };

    private static string GetCategoryColor(UnitCategory category, bool isOver, bool isMet) =>
        isOver ? "bg-healthy-danger" : isMet ? "bg-healthy-primary" : category switch
        {
            UnitCategory.Proteins => "bg-healthy-earth",
            UnitCategory.Vegetables => "bg-healthy-secondary",
            UnitCategory.Fruits => "bg-healthy-fruit/70",
            UnitCategory.Starches => "bg-healthy-grain",
            UnitCategory.Fats => "bg-healthy-grain/70",
            UnitCategory.Dairy => "bg-healthy-water/70",
            _ => "bg-healthy-muted"
        };
}
