@using PoNovaWeight.Shared.DTOs

<div class="bg-healthy-card rounded-xl shadow-healthy p-3">
    <h3 class="text-sm font-semibold text-healthy-text mb-3 flex items-center gap-2">
        <span class="text-lg">üéØ</span>
        Daily Health Tracking
    </h3>

    <!-- Weight Input -->
    <div class="mb-3">
        <label class="block text-xs font-medium text-healthy-muted mb-1">Weight (lbs)</label>
        <div class="flex items-center gap-2">
            <input type="number" 
                   step="0.1" 
                   min="50" 
                   max="500"
                   placeholder="Enter weight"
                   value="@WeightInputValue"
                   @oninput="OnWeightInput"
                   class="flex-1 px-3 py-2 text-sm rounded-lg border border-healthy-light bg-healthy-bg text-healthy-text placeholder-healthy-muted focus:outline-none focus:ring-2 focus:ring-healthy-primary focus:border-transparent" />
            @if (Weight.HasValue)
            {
                <button @onclick="ClearWeight" 
                        class="p-2 text-healthy-muted hover:text-healthy-danger transition-colors"
                        title="Clear weight">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            }
        </div>
        @if (ShowWeightWarning)
        {
            <p class="mt-1 text-xs text-healthy-warning">‚ö†Ô∏è Weight changed by @WeightDelta lbs from yesterday</p>
        }
    </div>

    <!-- OMAD Radio -->
    <div class="mb-3">
        <div class="flex items-center gap-2 mb-2">
            <span class="text-lg">üçΩÔ∏è</span>
            <span class="text-sm font-medium text-healthy-text">Did you eat OMAD today?</span>
        </div>
        <div class="flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" 
                       name="omad" 
                       checked="@(OmadCompliant == true)"
                       @onchange="() => SetOmad(true)"
                       class="w-4 h-4 text-healthy-primary focus:ring-healthy-primary" />
                <span class="text-sm text-healthy-text">Yes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" 
                       name="omad" 
                       checked="@(OmadCompliant == false)"
                       @onchange="() => SetOmad(false)"
                       class="w-4 h-4 text-healthy-primary focus:ring-healthy-primary" />
                <span class="text-sm text-healthy-text">No</span>
            </label>
        </div>
    </div>

    <!-- Alcohol Radio -->
    <div>
        <div class="flex items-center gap-2 mb-2">
            <span class="text-lg">üç∫</span>
            <span class="text-sm font-medium text-healthy-text">Did you drink alcohol today?</span>
        </div>
        <div class="flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" 
                       name="alcohol" 
                       checked="@(AlcoholConsumed == true)"
                       @onchange="() => SetAlcohol(true)"
                       class="w-4 h-4 text-healthy-primary focus:ring-healthy-primary" />
                <span class="text-sm text-healthy-text">Yes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" 
                       name="alcohol" 
                       checked="@(AlcoholConsumed == false)"
                       @onchange="() => SetAlcohol(false)"
                       class="w-4 h-4 text-healthy-primary focus:ring-healthy-primary" />
                <span class="text-sm text-healthy-text">No</span>
            </label>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public decimal? Weight { get; set; }

    [Parameter]
    public bool? OmadCompliant { get; set; }

    [Parameter]
    public bool? AlcoholConsumed { get; set; }

    [Parameter]
    public decimal? PreviousDayWeight { get; set; }

    [Parameter]
    public EventCallback<decimal?> WeightChanged { get; set; }

    [Parameter]
    public EventCallback<bool?> OmadCompliantChanged { get; set; }

    [Parameter]
    public EventCallback<bool?> AlcoholConsumedChanged { get; set; }

    private string WeightInputValue => Weight?.ToString("0.#") ?? "";

    private bool ShowWeightWarning => 
        Weight.HasValue && 
        PreviousDayWeight.HasValue && 
        Math.Abs(Weight.Value - PreviousDayWeight.Value) > 5m;

    private decimal WeightDelta => 
        Weight.HasValue && PreviousDayWeight.HasValue 
            ? Math.Abs(Weight.Value - PreviousDayWeight.Value) 
            : 0m;

    private async Task OnWeightInput(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var weight))
        {
            // Round to one decimal place
            weight = Math.Round(weight, 1);
            await WeightChanged.InvokeAsync(weight);
        }
        else if (string.IsNullOrWhiteSpace(e.Value?.ToString()))
        {
            await WeightChanged.InvokeAsync(null);
        }
    }

    private async Task ClearWeight()
    {
        await WeightChanged.InvokeAsync(null);
    }

    private async Task SetOmad(bool value)
    {
        // If clicking the same value, clear it (toggle off)
        bool? newValue = OmadCompliant == value ? null : value;
        await OmadCompliantChanged.InvokeAsync(newValue);
    }

    private async Task SetAlcohol(bool value)
    {
        // If clicking the same value, clear it (toggle off)
        bool? newValue = AlcoholConsumed == value ? null : value;
        await AlcoholConsumedChanged.InvokeAsync(newValue);
    }

    private async Task ToggleOmad()
    {
        // Toggle through: null -> true -> false -> null
        bool? newValue = OmadCompliant switch
        {
            null => true,
            true => false,
            false => null
        };
        await OmadCompliantChanged.InvokeAsync(newValue);
    }

    private async Task ToggleAlcohol()
    {
        // Toggle through: null -> true -> false -> null
        bool? newValue = AlcoholConsumed switch
        {
            null => true,
            true => false,
            false => null
        };
        await AlcoholConsumedChanged.InvokeAsync(newValue);
    }

    private static string GetToggleClass(bool? value) => value switch
    {
        true => "relative inline-flex h-6 w-11 items-center rounded-full bg-healthy-primary transition-colors focus:outline-none focus:ring-2 focus:ring-healthy-primary focus:ring-offset-2",
        false => "relative inline-flex h-6 w-11 items-center rounded-full bg-healthy-danger transition-colors focus:outline-none focus:ring-2 focus:ring-healthy-primary focus:ring-offset-2",
        null => "relative inline-flex h-6 w-11 items-center rounded-full bg-healthy-light transition-colors focus:outline-none focus:ring-2 focus:ring-healthy-primary focus:ring-offset-2"
    };

    private static string GetToggleKnobClass(bool? value) => value switch
    {
        true => "inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6",
        false => "inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1",
        null => "inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-3"
    };
}
