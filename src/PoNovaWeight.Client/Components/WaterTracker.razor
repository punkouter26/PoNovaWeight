@using PoNovaWeight.Shared.Contracts

<div class="bg-healthy-card rounded-xl shadow-healthy border border-healthy-light p-3">
    <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
            <span class="text-base">ðŸ’§</span>
            <span class="text-sm font-semibold text-healthy-text">Water</span>
            @if (FilledSegments >= UnitCategoryInfo.WaterTargetSegments)
            {
                <span class="text-[9px] px-1.5 py-0.5 bg-healthy-water/10 text-healthy-water rounded-full">âœ“</span>
            }
        </div>
        <span class="text-[11px] text-healthy-muted">@FilledSegments/@UnitCategoryInfo.WaterTargetSegments glasses</span>
    </div>

    <!-- Compact 8-segment water tracker -->
    <div class="flex justify-center gap-1.5">
        @for (int i = 0; i < UnitCategoryInfo.WaterTargetSegments; i++)
        {
            var index = i; // Capture for closure
            var filled = index < FilledSegments;
            
            <button @onclick="() => ToggleSegment(index)"
                    class="water-segment @(filled ? "water-segment-filled" : "water-segment-empty")"
                    data-water-segment="@(index + 1)"
                    aria-label="@(filled ? "Remove" : "Add") water glass @(index + 1)">
                @if (filled)
                {
                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/>
                    </svg>
                }
            </button>
        }
    </div>

    <!-- Compact progress bar -->
    <div class="mt-2">
        <div class="progress-bar">
            <div class="progress-fill bg-healthy-water" style="width: @ProgressPercent%"></div>
        </div>
    </div>

    @if (FilledSegments >= UnitCategoryInfo.WaterTargetSegments)
    {
        <div class="mt-1.5 text-center text-[10px] text-healthy-water font-medium">
            Daily water goal reached! ðŸ’¦
        </div>
    }
</div>

@code {
    [Parameter]
    public int FilledSegments { get; set; }

    [Parameter]
    public EventCallback<int> OnSegmentChanged { get; set; }

    private int ProgressPercent => (int)((double)FilledSegments / UnitCategoryInfo.WaterTargetSegments * 100);

    private async Task ToggleSegment(int index)
    {
        // Clicking on a filled segment or beyond sets the count to that position + 1
        // Clicking on the last filled segment decrements
        int newSegments;
        
        if (index < FilledSegments)
        {
            // Clicking on a filled segment - set to that index (effectively removing from this point)
            newSegments = index;
        }
        else
        {
            // Clicking on empty segment - fill up to and including this segment
            newSegments = index + 1;
        }
        
        await OnSegmentChanged.InvokeAsync(newSegments);
    }
}
