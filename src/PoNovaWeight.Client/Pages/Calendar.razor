@page "/calendar"
@attribute [Authorize]
@using PoNovaWeight.Client.Components
@inject ApiClient Api
@inject NavigationManager Navigation

<PageTitle>Calendar | PoNovaWeight</PageTitle>

<div class="space-y-4">
    <h1 class="text-xl font-bold text-healthy-text dark:text-dark-text text-center flex items-center justify-center gap-2">
        <svg class="w-6 h-6 text-healthy-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>
        OMAD Calendar
    </h1>

    @if (IsLoading)
    {
        <CalendarSkeleton />
    }
    else
    {
        <CalendarGrid 
            Year="@CurrentYear"
            Month="@CurrentMonth"
            Days="@MonthlyData?.Days"
            OnMonthChanged="@HandleMonthChanged"
            OnDaySelected="@HandleDaySelected" />

        @if (MonthlyData?.Days.Count > 0)
        {
            <div class="bg-white dark:bg-dark-card rounded-2xl shadow-elevation-2 border border-healthy-light dark:border-dark-border p-5">
                <h3 class="text-sm font-semibold text-healthy-text dark:text-dark-text mb-4 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
                    </div>
                    Monthly Summary
                </h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-gray-50 dark:bg-dark-border rounded-xl">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400">@OmadDaysCount</div>
                        <div class="text-xs text-healthy-muted dark:text-dark-muted font-medium">OMAD Days</div>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-dark-border rounded-xl">
                        <div class="text-2xl font-bold text-red-600 dark:text-red-400">@NonOmadDaysCount</div>
                        <div class="text-xs text-healthy-muted dark:text-dark-muted font-medium">Non-OMAD</div>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-dark-border rounded-xl">
                        <div class="text-2xl font-bold text-healthy-primary">@CompliancePercentage%</div>
                        <div class="text-xs text-healthy-muted dark:text-dark-muted font-medium">Compliance</div>
                    </div>
                </div>
            </div>
        }
    }

    <div class="pt-2">
        <a href="/" class="flex items-center justify-center gap-2 w-full py-3 px-4 text-healthy-primary dark:text-healthy-light text-sm font-semibold hover:bg-healthy-light dark:hover:bg-dark-border rounded-xl transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/></svg>
            Back to Dashboard
        </a>
    </div>
</div>

@code {
    private int CurrentYear { get; set; }
    private int CurrentMonth { get; set; }
    private MonthlyLogsDto? MonthlyData { get; set; }
    private bool IsLoading { get; set; } = true;

    private int OmadDaysCount => MonthlyData?.Days.Count(d => d.OmadCompliant == true) ?? 0;
    private int NonOmadDaysCount => MonthlyData?.Days.Count(d => d.OmadCompliant == false) ?? 0;
    private int CompliancePercentage
    {
        get
        {
            var total = OmadDaysCount + NonOmadDaysCount;
            return total > 0 ? (int)Math.Round(100.0 * OmadDaysCount / total) : 0;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var today = DateTime.Today;
        CurrentYear = today.Year;
        CurrentMonth = today.Month;
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            MonthlyData = await Api.GetMonthlyLogsAsync(CurrentYear, CurrentMonth);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading monthly data: {ex.Message}");
            MonthlyData = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleMonthChanged((int Year, int Month) newMonth)
    {
        CurrentYear = newMonth.Year;
        CurrentMonth = newMonth.Month;
        await LoadMonthData();
    }

    private void HandleDaySelected(DateOnly date)
    {
        Navigation.NavigateTo($"/day/{date:yyyy-MM-dd}");
    }
}
