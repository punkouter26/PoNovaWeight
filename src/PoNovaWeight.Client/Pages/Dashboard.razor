@page "/"
@attribute [Authorize]
@using PoNovaWeight.Client.Components
@using PoNovaWeight.Shared.DTOs
@inject ApiClient Api

<PageTitle>Dashboard - PoNovaWeight</PageTitle>

@if (IsLoading)
{
    <div class="flex justify-center py-8">
        <div class="w-6 h-6 border-3 border-healthy-primary border-t-transparent rounded-full animate-spin"></div>
    </div>
}
else if (Summary is not null)
{
    <!-- OMAD Streak Display -->
    @if (Streak is not null)
    {
        <div class="mb-4">
            <StreakDisplay Streak="@Streak" />
        </div>
    }

    <!-- Weight Trend Chart -->
    @if (WeightTrends is not null)
    {
        <div class="mb-4">
            <WeightTrendChart DataPoints="@MapTrendDataPoints(WeightTrends)"
                              TotalDaysLogged="@WeightTrends.TotalDaysLogged"
                              WeightChange="@WeightTrends.WeightChange" />
        </div>
    }

    <!-- Alcohol Insights -->
    @if (AlcoholCorrelation is not null)
    {
        <div class="mb-4">
            <AlcoholInsights Correlation="@AlcoholCorrelation" />
        </div>
    }

    <!-- Weekly summary card -->
    <WeeklySummary Summary="@Summary" />

    <!-- Day cards in a compact vertical list -->
    <div class="space-y-2">
        <h3 class="text-[11px] font-medium text-healthy-muted uppercase tracking-wide flex items-center gap-1">
            <span>ðŸ“…</span> This Week
        </h3>
        
        @foreach (var day in Summary.Days.OrderByDescending(d => d.Date))
        {
            <DayCard Day="@day" />
        }
    </div>
}
else
{
    <div class="text-center py-8 text-healthy-muted">
        <p class="text-sm">Unable to load weekly summary.</p>
        <button @onclick="LoadWeeklySummary" class="mt-3 text-sm text-healthy-primary hover:underline">
            Try again
        </button>
    </div>
}

@code {
    private WeeklySummaryDto? Summary { get; set; }
    private StreakDto? Streak { get; set; }
    private WeightTrendsDto? WeightTrends { get; set; }
    private AlcoholCorrelationDto? AlcoholCorrelation { get; set; }
    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadWeeklySummary();
    }

    private async Task LoadWeeklySummary()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var today = DateOnly.FromDateTime(DateTime.Today);
            
            // Load weekly summary, streak, weight trends, and alcohol correlation in parallel
            var summaryTask = Api.GetWeeklySummaryAsync(today);
            var streakTask = Api.GetStreakAsync();
            var trendsTask = Api.GetWeightTrendsAsync(30);
            var alcoholTask = Api.GetAlcoholCorrelationAsync(90);
            
            await Task.WhenAll(summaryTask, streakTask, trendsTask, alcoholTask);
            
            Summary = await summaryTask;
            Streak = await streakTask;
            WeightTrends = await trendsTask;
            AlcoholCorrelation = await alcoholTask;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading weekly summary: {ex.Message}");
            Summary = null;
            Streak = null;
            WeightTrends = null;
            AlcoholCorrelation = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private List<WeightTrendChart.TrendDataPoint> MapTrendDataPoints(WeightTrendsDto trends)
    {
        return trends.DataPoints.Select(p => new WeightTrendChart.TrendDataPoint
        {
            Date = p.Date,
            Weight = p.Weight,
            IsCarryForward = p.IsCarryForward,
            AlcoholConsumed = p.AlcoholConsumed
        }).ToList();
    }
}
