@page "/"
@attribute [Authorize]
@using PoNovaWeight.Client.Components
@using PoNovaWeight.Shared.DTOs
@inject ApiClient Api
@inject IJSRuntime JS

<PageTitle>Dashboard - PoNovaWeight</PageTitle>

@if (IsLoading)
{
    <div class="flex justify-center py-8 lg:py-16">
        <div class="w-6 h-6 lg:w-8 lg:h-8 border-3 border-healthy-primary border-t-transparent rounded-full animate-spin"></div>
    </div>
}
else if (ShowOnboarding)
{
    <!-- Onboarding Flow for New Users -->
    <Onboarding OnComplete="CompleteOnboarding" />
}
else if (Summary is not null)
{
    <!-- Desktop: 2-column layout, Mobile: single column -->
    <div class="lg:grid lg:grid-cols-12 lg:gap-6">
        
        <!-- Left Column: Stats & Charts (spans 7 cols on desktop) -->
        <div class="lg:col-span-7 space-y-4">
            <!-- OMAD Streak Display -->
            @if (Streak is not null)
            {
                <StreakDisplay Streak="@Streak" />
            }

            <!-- Weight Trend Chart -->
            @if (WeightTrends is not null)
            {
                <WeightTrendChart DataPoints="@MapTrendDataPoints(WeightTrends)"
                                  TotalDaysLogged="@WeightTrends.TotalDaysLogged"
                                  WeightChange="@WeightTrends.WeightChange" />
            }

            <!-- Alcohol Insights -->
            @if (AlcoholCorrelation is not null)
            {
                <AlcoholInsights Correlation="@AlcoholCorrelation" />
            }

            <!-- Weekly summary card -->
            <WeeklySummary Summary="@Summary" />
        </div>

        <!-- Right Column: Daily Activity (spans 5 cols on desktop) -->
        <div class="lg:col-span-5 mt-4 lg:mt-0">
            <!-- Quick Actions Card (Desktop only) -->
            <div class="hidden lg:block bg-healthy-card rounded-xl shadow-healthy border border-healthy-light p-4 mb-4">
                <h3 class="text-sm font-semibold text-healthy-text mb-3 flex items-center gap-2">
                    <span>âš¡</span> Quick Actions
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="/day/@DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd")"
                       class="flex flex-col items-center gap-2 p-4 bg-healthy-bg rounded-lg hover:bg-healthy-light transition-colors group">
                        <div class="w-10 h-10 rounded-full bg-healthy-primary/10 flex items-center justify-center group-hover:bg-healthy-primary/20 transition-colors">
                            <svg class="w-5 h-5 text-healthy-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-healthy-text">Log Today</span>
                    </a>
                    <a href="/scan/@DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd")"
                       class="flex flex-col items-center gap-2 p-4 bg-healthy-bg rounded-lg hover:bg-healthy-light transition-colors group">
                        <div class="w-10 h-10 rounded-full bg-healthy-secondary/10 flex items-center justify-center group-hover:bg-healthy-secondary/20 transition-colors">
                            <svg class="w-5 h-5 text-healthy-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-healthy-text">Scan Meal</span>
                    </a>
                </div>
            </div>

            <!-- Day cards in a compact vertical list -->
            <div class="space-y-2">
                <h3 class="text-[11px] font-medium text-healthy-muted uppercase tracking-wide flex items-center gap-1">
                    <span>ðŸ“…</span> This Week
                </h3>
                
                @foreach (var day in Summary.Days.OrderByDescending(d => d.Date))
                {
                    <DayCard Day="@day" />
                }
            </div>
        </div>
    </div>
}
else
{
    <!-- Empty State with Rich Content -->
    <EmptyDashboard OnGetStarted="StartOnboarding" OnRetry="LoadWeeklySummary" />
}

@code {
    private WeeklySummaryDto? Summary { get; set; }
    private StreakDto? Streak { get; set; }
    private WeightTrendsDto? WeightTrends { get; set; }
    private AlcoholCorrelationDto? AlcoholCorrelation { get; set; }
    private bool IsLoading { get; set; } = true;
    private bool ShowOnboarding { get; set; }
    private bool HasCompletedOnboarding { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Check if user has completed onboarding
        HasCompletedOnboarding = await CheckOnboardingStatus();
        await LoadWeeklySummary();
    }

    private async Task<bool> CheckOnboardingStatus()
    {
        try
        {
            var status = await JS.InvokeAsync<string?>("localStorage.getItem", "novaweight_onboarding_complete");
            return status == "true";
        }
        catch
        {
            return false;
        }
    }

    private async Task LoadWeeklySummary()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var today = DateOnly.FromDateTime(DateTime.Today);
            
            // Load weekly summary, streak, weight trends, and alcohol correlation in parallel
            var summaryTask = Api.GetWeeklySummaryAsync(today);
            var streakTask = Api.GetStreakAsync();
            var trendsTask = Api.GetWeightTrendsAsync(30);
            var alcoholTask = Api.GetAlcoholCorrelationAsync(90);
            
            await Task.WhenAll(summaryTask, streakTask, trendsTask, alcoholTask);
            
            Summary = await summaryTask;
            Streak = await streakTask;
            WeightTrends = await trendsTask;
            AlcoholCorrelation = await alcoholTask;

            // Show onboarding if new user (no data and hasn't completed onboarding)
            var hasNoData = (WeightTrends?.TotalDaysLogged ?? 0) == 0 && (Streak?.CurrentStreak ?? 0) == 0;
            if (hasNoData && !HasCompletedOnboarding)
            {
                ShowOnboarding = true;
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading weekly summary: {ex.Message}");
            Summary = null;
            Streak = null;
            WeightTrends = null;
            AlcoholCorrelation = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void StartOnboarding()
    {
        ShowOnboarding = true;
        StateHasChanged();
    }

    private async Task CompleteOnboarding()
    {
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "novaweight_onboarding_complete", "true");
        }
        catch { }
        
        HasCompletedOnboarding = true;
        ShowOnboarding = false;
        StateHasChanged();
    }

    private List<WeightTrendChart.TrendDataPoint> MapTrendDataPoints(WeightTrendsDto trends)
    {
        return trends.DataPoints.Select(p => new WeightTrendChart.TrendDataPoint
        {
            Date = p.Date,
            Weight = p.Weight,
            IsCarryForward = p.IsCarryForward,
            AlcoholConsumed = p.AlcoholConsumed
        }).ToList();
    }
}
